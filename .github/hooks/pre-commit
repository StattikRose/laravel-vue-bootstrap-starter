#!/bin/bash

ERRORS=0

# check if stdout is a terminal...
if test -t 1; then

    # see if it supports colors...
    ncolors=$(tput colors)

    if test -n "$ncolors" && test $ncolors -ge 8; then
        bold="$(tput bold)"
        underline="$(tput smul)"
        standout="$(tput smso)"
        normal="$(tput sgr0)"
        black="$(tput setaf 0)"
        red="$(tput setaf 1)"
        green="$(tput setaf 2)"
        yellow="$(tput setaf 3)"
        blue="$(tput setaf 4)"
        magenta="$(tput setaf 5)"
        cyan="$(tput setaf 6)"
        white="$(tput setaf 7)"
    fi
fi

function makeTitle()
{
    echo -e "\n\n${standout} ------------------------ $1  ------------------------ ${normal}\n"
}

function makeHint()
{
    echo -e "\n${magenta} > HINT: $1 ${normal}\n"
}

function makeError()
{
    echo -e "${red} ---- $1 ---- ${normal} \r\n"
}

function makeSuccess()
{
    echo -e "${green} ------------------------ $1 ------------------------ ${normal} \r\n"
}

makeTitle "Git"
echo -e "Committing as $(git config user.name)"
echo -e "$(git status)"
echo -e "$(git add .)"

# for linting js files
function eslint () {
  makeTitle 'ESLINT'

  OUTPUT=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(.vue|.js)$')

  OUTPUT=${OUTPUT//.eslintrc.js/}
  a=("${OUTPUT}")

  if [[ $a == "" ]]; then
    return
  fi

  e=$(npx eslint -c .eslintrc.js $a)

  if [[ "$e" != "" ]]; then
    echo -e "$e"
    makeHint "Check eslint errors. Run \`npm run lint-fix\` to fix the files."
    ERRORS=1
  fi
}
eslint

# for linting php files
function phplint () {
  makeTitle 'PHP LINT'
  echo -e "$(php -v)"
  echo -e "\r"

  OUTPUT=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(.php)$')

  if [[ "$OUTPUT" = "" ]]; then
    return
  fi

  for i in $(git diff --cached --name-only --diff-filter=ACM | grep -E '(.php)$')
    do
    p=$(php -l $i)

    if [[ "$p" != *"No syntax errors detected"* ]]; then
      echo -e "\n"$i - $p
    fi

    if [[ "$p" != *"No syntax errors detected"* && ERRORS != 1 ]]; then
      ERRORS="1"
    fi
  done
}
phplint

# for phpcs files
function phpcs () {
  makeTitle 'PHPCS'
  p=$(php ./vendor/bin/phpcs -qp --standard=PSR2 ./app ./tests ./config ./tests)

    if [[ "$p" != "" ]]; then
      echo -e "\n$i - $p"
      makeHint "Check PHPCS errors. Run \`composer cs-fix\` to fix the files."
    fi

    if [[ "$p" != "" && ERRORS != 1 ]]; then
      ERRORS="1"
    fi
    return
}
phpcs

echo -e "\r"

if [[ "$ERRORS" != "0" ]]; then
  makeError "Errors were found and the commit was rejected."
  exit 1 #reject
else
  makeSuccess "SUCCESS!"
  exit 0 #accept
fi
